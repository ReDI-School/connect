'use strict'
const fs = require('fs')
const app = require('../server/server.js')
const nodemailer = require('nodemailer')
const Rx = require('rxjs')
const path = require('path')
const mjml2html = require('mjml')
const { bindNodeCallback, from } = Rx
const aws = require('aws-sdk')

const {
  delay,
  concatMap,
  take,
  skip,
  map,
  switchMap,
  tap,
  filter,
  startWith,
  count,
} = require('rxjs/operators')

const { RedUser } = app.models

const config = {
  accessKeyId: process.env.EMAILER_AWS_ACCESS_KEY,
  secretAccessKey: process.env.EMAILER_AWS_SECRET_KEY,
  region: process.env.EMAILER_AWS_REGION,
}

const ses = new aws.SES(config)

const transporter = nodemailer.createTransport({
  SES: ses,
})

const newsletterTemplateMjml = fs.readFileSync(
  path.resolve(
    __dirname,
    '..',
    'lib',
    'email',
    'templates',
    'newsletter.career.support.team.mjml'
  ),
  'utf-8'
)
const emailBodyMjml = newsletterTemplateMjml.replace(
  '${NEWSLETTER_BODY}',
  `

<mj-text mj-class="headline">Mentors’ Kick-Off Spring Semester 2022</mj-text>

<mj-divider mj-class="divider-top" css-class="divider" />

<mj-text mj-class="text" padding="0 0 20px 0">Dear ReDI Supermentors! 🦸🦸️</mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">🌿🌸The spring semester 2022 has just started and we are excited to welcome around 500 (!) students this semester to our DCP classes in Berlin, Munich and NRW! </mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">👩‍🏫 Berlin is offering 12 courses, Munich has 10 courses and NRW provides 9 courses for our new tech talents. From Data Analytics to Cloud Computing, Frontend Development and UX/UI Design, our learners have a variety of exciting tracks to embark on their tech journey. 🎨💻</mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">🆕 Also, new ReDI schools in Hamburg, Aarhus, Malmö and Cyberspace will soon be opening their gates for more learners. To get the latest information about what’s happening in these new locations, please check out <a href="https://www.redi-school.org/">our website</a>. 🤫 Pssst, a shiny new website will be launched soon! </mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">📆 To kick off the new semester in style, we are inviting you to our <strong>mentors’ kick-off event on Thursday, 24 March from 6:30 - 7:30pm</strong>. It will be a casual online event for new and experienced mentors to meet from all locations. You can register <a href="https://redi-school-org.zoom.us/meeting/register/tJItcOCprTgoE9NTspD5j9_egfKVptqLgi0K">here</a> to join the meeting.</mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">🥁 This will be just the start of a series of mentor meet-ups which we will offer on a <strong>bi-weekly basis</strong>. Every other Thursday at 6:30pm, we will host an online meeting for any mentor to join to share experiences, ask questions and support each other in their journeys as mentors with ReDI school. These meetups will be open to all ReDI school mentors, including from our digital literacy programs, i.e. the Digital Women and Digital Youth Program.</mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">🧑‍🎓 We will also offer a number of training sessions specifically tailored to our mentor community. On <strong>Thursday, 7 April, from 6:30 - 8:30pm</strong>, we will offer our <strong>‘Mentoring 101’ workshop</strong> with our wonderful trainer Lena Johanna Schmitt. This is an interactive training recommended for all new mentors to learn and practice what it means to be a mentor. Places are limited, so <a href="https://redi-school-org.zoom.us/meeting/register/tJApdOuvrjsjHdT8_1AkgnG8HZeZmoltLFRP">sign up here</a>. In case you cannot participate, please cancel in advance so we are able to give your place to someone else. </mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">⚡️⏳On <strong>Thursday, 5 May</strong>, we will offer a training session with our lovely trainers Mira & Peter who will speak about the topic <strong>Energy vs. time management</strong>, which was a suggestion from our community. They are experts in holding an open and safe space to share experiences and learn from each other in conversation. We will share the sign-up link for this training session closer to the date. </mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">🗣 If you have suggestions for other training topics, please let us know! And don’t forget the bi-weekly mentor meet-ups will also be a great opportunity to exchange perspectives with other mentors and learn from each other. </mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">🙌 If you are not yet on our ReDI slack space, <a href="https://join.slack.com/t/redi-school/shared_invite/zt-yx95a42f-jserxMHtnXxdKtmQzdTAAg">come join us</a> to be informed of all events. Write to @Miriam or @Johanna to be added to the #mentors_and_careertrainers channel. 🔗We also have a <a href="https://www.linkedin.com/groups/8733859/">LinkedIn group</a> that you are very welcome to join. </mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">📝Our new students are already signing up to ReDI Connect and are onboarded by Johanna. So get ReDI to hopefully receive an application by one of our mentees soon!</mj-text>

<mj-text mj-class="text" padding="0 0 20px 0">❓ If you have any questions, concerns or feedback in the meantime, please always feel free to reach out to us. We are happy to support you! 💁‍♀️💁‍♀️</mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">Thank you for being amazing! 🚀</mj-text>
 
<mj-text mj-class="text" padding="0 0 20px 0">Miriam & Johanna<br />
ReDI Career Support Team</mj-text>

`
)

const emailBodyParsed = mjml2html(emailBodyMjml, {
  filePath: path.resolve(__dirname, '..', 'lib', 'email', 'templates'),
})

const sendMjmlEmail = Rx.bindNodeCallback(
  transporter.sendMail.bind(transporter)
)

/* eslint-disable-next-line */
const sendEmail = ({ recipient, firstName }) => {
  const mailOptions = {
    from: 'career@redi-school.org',
    replyTo: 'career@redi-school.org',
    to: recipient,
    subject: 'Mentors’ Kick-Off Spring Semester 2022',
    html: emailBodyParsed.html.replace(':firstName:', firstName),
  }

  return sendMjmlEmail(mailOptions)
}

// const emails = `eric@binarylights.com`.split(`\n`)

const redUserFind = (q) => bindNodeCallback(RedUser.find.bind(RedUser))(q)

redUserFind({ include: 'redProfile' })
  .pipe(
    delay(1000),
    switchMap((users) => from(users)),
    map((data) => {
      const pojo = JSON.parse(JSON.stringify(data))
      return {
        redUser: pojo,
        redProfile: pojo.redProfile,
        redUserInst: data,
        redProfileInst: data.redProfile,
      }
    }),
    filter(({ redProfile }) => !!redProfile),
    filter(({ redProfile }) => redProfile.userType === 'mentor'),
    filter(({ redProfile }) => redProfile.userActivated),

    // take(1),
    // map((data, index) => {
    //   data.redProfile.contactEmail =
    //     index === 0 ? 'miriam@redi-school.org' : 'johanna@redi-school.org'
    //   return data
    // }),
    concatMap(
      (userData) =>
        sendEmail({
          recipient: userData.redProfile.contactEmail,
          firstName: userData.redProfile.firstName,
        }).pipe(delay(500)),

      (userData, sendResult) => ({ ...userData, sendResult })
    ),

    tap((userData) => console.log(userData.redProfile.contactEmail)),
    count()
  )
  .subscribe(
    (count) => console.log('did this ' + count + ' times'),
    (e) => console.log('Error: ', e),
    () => console.log('done')
  )
